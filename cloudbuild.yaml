steps:
  # 1. Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'build',
        '-t',
        'us-central1-docker.pkg.dev/$PROJECT_ID/portfolio/portfolio-backend:$COMMIT_SHA',
        './backend'
      ]

  # 2. Push the image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'push',
        'us-central1-docker.pkg.dev/$PROJECT_ID/portfolio/portfolio-backend:$COMMIT_SHA'
      ]

  # 3. Run Django migrations
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud run jobs create migrate-job-$COMMIT_SHA \
          --image us-central1-docker.pkg.dev/$PROJECT_ID/portfolio/portfolio-backend:$COMMIT_SHA \
          --command python \
          --args manage.py,migrate \
          --set-cloudsql-instances=$PROJECT_ID:us-central1:portfolio-db-instance \
          --set-env-vars DATABASE_URL=postgresql://${_DB_USER}:${_DB_PASSWORD}@/portfolio_db?host=/cloudsql/$PROJECT_ID:us-central1:portfolio-db-instance \
          --region us-central1 \
          --execute-now \
          --wait \
          --quiet

  # 4. Deploy backend
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      [
        'run',
        'deploy',
        'portfolio-backend',
        '--image',
        'us-central1-docker.pkg.dev/$PROJECT_ID/portfolio/portfolio-backend:$COMMIT_SHA',
        '--region',
        'us-central1',
        '--add-cloudsql-instances',
        '$PROJECT_ID:us-central1:portfolio-db-instance',
        '--update-env-vars',
        'DATABASE_URL=postgresql://${_DB_USER}:${_DB_PASSWORD}@/portfolio_db?host=/cloudsql/$PROJECT_ID:us-central1:portfolio-db-instance,DEBUG=False,ALLOWED_HOSTS=*',
        '--allow-unauthenticated'
      ]

images:
  - us-central1-docker.pkg.dev/$PROJECT_ID/portfolio/portfolio-backend:$COMMIT_SHA

options:
  logging: CLOUD_LOGGING_ONLY
